name: Update Homebrew Formula

on:
  push:
    tags:
      - 'V*'

jobs:
  update-formula:
    runs-on: ubuntu-latest
    steps:
      - name: Extract version from tag
        id: tag_version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#V}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Releasing version: $VERSION (tag: $TAG)"

      - name: Update Homebrew formula
        uses: mislav/bump-homebrew-formula-action@v3
        with:
          formula-name: mole
          formula-path: Formula/mole.rb
          homebrew-tap: tw93/homebrew-tap
          tag-name: ${{ steps.tag_version.outputs.tag }}
          commit-message: |
            mole ${{ steps.tag_version.outputs.version }}

            Automated release via GitHub Actions
        env:
          COMMITTER_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Verify formula update
        if: success()
        run: |
          echo "âœ“ Homebrew formula updated successfully"
          echo "  Version: ${{ steps.tag_version.outputs.version }}"
          echo "  Tag: ${{ steps.tag_version.outputs.tag }}"
